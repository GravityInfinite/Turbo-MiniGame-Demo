!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["turbo.min"]=t():e["turbo.min"]=t()}(self,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};function n(){return wx.getLaunchOptionsSync().query||{}}function r(e){const t=[];for(let n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}e.r(t),e.d(t,{default:()=>S});const o=function(){if(S?._para?.show_log&&"object"==typeof console&&console.log)try{if(3===arguments.length)return console.log(arguments[0],arguments[1],arguments[2]);if(2===arguments.length)return console.log(arguments[0],arguments[1]);if(1===arguments.length)return console.log(arguments[0])}catch(e){console.log(arguments[0])}};var i=Object.prototype,a=Array.prototype,s=a.forEach,c=i.hasOwnProperty,u=a.slice;function l(e){return null!=e&&"[object Object]"==toString.call(e)}function p(e,t,n){if(null==e)return!1;var r={};if(s&&e.forEach===s)e.forEach(t,n);else if(e.length===+e.length){for(var o=0,i=e.length;o<i;o++)if(o in e&&t.call(n,e[o],o,e)===r)return!1}else for(var a in e)if(c.call(e,a)&&t.call(n,e[a],a,e)===r)return!1}function f(e){return p(u.call(arguments,1),(function(t){for(var n in t)void 0!==t[n]&&(e[n]=t[n])})),e}function _(){var e={};try{var t=getCurrentPages();e=t[t.length-1]}catch(e){o(e)}return e}const h={"content-type":"application/json"},d="https://turbo.api.plutus-cat.com/event_center/api/v1";function g(){if(!S?._globalData?.access_token)throw new Error("access_token is missing, you must call init first.");if(!S?._globalData?.client_id)throw new Error("client_id is missing, you must call init first.")}let m=null;const y={appLaunch:function(e){S?._para?.autoTrack?.appLaunch&&S.track("$MPLaunch",{$is_first_time:S._is_first_launch,$url_query:r(e.query),$scene:String(e.scene)})},appShow:function(e){m=(new Date).getTime(),S._current_scene=e.scene,S?._para?.autoTrack?.appShow&&S.track("$MPShow",{$url_query:r(e.query),$scene:String(e.scene)})},appHide:function(){if(!S?._para?.autoTrack?.appHide)return;let e=null;const t=(new Date).getTime();m&&t-m>0&&(t-m)/36e5<24&&(e=t-m),S.track("$MPHide",{$event_duration:e})}},v={properties:{},getAppInfoSync:function(){if(wx.getAccountInfoSync){const e=wx.getAccountInfoSync(),t={$app_id:(e&&e.miniProgram?e.miniProgram:{}).appId};for(let e in t)t.hasOwnProperty(e)&&(this.properties[e]=t[e]);return t}return{}},getNetworkType:function(){const e=this;wx.getNetworkType({success:function(t){e.properties.$network_type=t.networkType}})},getSystemInfoSync:function(){if(wx.getSystemInfoSync){const e=wx.getSystemInfoSync(),t={$screen_width:e.screenWidth,$screen_height:e.screenHeight,$os_version:e.system,$os:e.platform,$model:e.model,$brand:String(e.brand).toLocaleUpperCase(),$manufacturer:e.brand,$lib_version:"1.0.0"};for(let e in t)t.hasOwnProperty(e)&&(this.properties[e]=t[e]);return t}return{}},getRegisterProperties:function(e={}){for(let t in e)this.properties[t]=e[t]},infoInit:function(){this.getAppInfoSync(),this.getNetworkType(),this.getSystemInfoSync()},getProperties:function(){return this.properties}},w={register:function(e={}){if(g(),!e?.name)throw new Error("name must be required");if(!e?.channel)throw new Error("channel must be required");if(!e?.version&&0!==e?.version)throw new Error("version must be required");if(t=e?.version,!("number"==typeof t?0==t-t:"string"==typeof t&&""!==t.trim()&&(Number.isFinite?Number.isFinite(+t):isFinite(+t)))||"number"!=typeof e?.version)throw new Error("version must be type: Number");var t;const r=function(){const e=n();return e.ksUnitId||e.ksCampaignId||e.ksChannel?"kuaishou":e.clue_token||e.ad_id||e.creative_id||e.request_id||e.advertiser_id?"bytedance":""}(),o={client_id:S._globalData.client_id,name:e.name,channel:e.channel,version:e.version,media_type:r||"tencent",wx_openid:e?.wx_openid||"",wx_unionid:e?.wx_unionid||"",click_id:e?.click_id||"",ad_data:{}},i=n();return"kuaishou"===r?o.ad_data={callback:i?.callback||"",ksCampaignId:i?.ksCampaignId||"",ksUnitId:i?.ksUnitId||"",ksCreativeId:i?.ksCreativeId||"",ksChannel:i?.ksChannel||""}:"bytedance"===r&&(o.ad_data={clue_token:i?.clue_token||"",ad_id:i?.ad_id||"",creative_id:i?.creative_id||"",advertiser_id:i?.advertiser_id||"",request_id:i?.request_id||""}),new Promise((function(e,t){wx.request({url:`${d}/user/register/?access_token=${S._globalData.access_token}`,method:"POST",header:h,data:o,success(n){if(200===n.statusCode)return S.profileSetOnce({$signup_time:(new Date).toLocaleString("cn",{hour12:!1}).replaceAll("/","-")}),void e(n.data);t(n)},fail(e){t(e)}})}))},handleEvent:function(e={}){if(g(),!e?.event_type)throw new Error("event_type must be required");const t={event_type:e?.event_type||""};return e?.properties&&(t.properties=e?.properties),e?.timestamp&&(t.timestamp=e?.timestamp),new Promise((function(e,n){wx.request({url:`${d}/event/handle_event/?access_token=${S._globalData.access_token}&client_id=${S._globalData.client_id}`,method:"POST",header:h,data:t,success(t){200===t.statusCode?e(t.data):n(t)},fail(e){n(e)}})}))},queryUser:function(){g();const e={user_list:[S._globalData.client_id]};return new Promise((function(t,n){wx.request({url:`${d}/user/get/?access_token=${S._globalData.access_token}`,method:"POST",header:h,data:e,success(e){200===e.statusCode?t(e.data):n(e)},fail(e){n(e)}})}))}};w._autoTrackCustom=y,w._globalData={access_token:"",client_id:""},w._batch_send_default={send_timeout:1e4,max_length:10},w._is_first_launch=!1,w._current_scene=null,w._store={storageInfo:null,mem:{mdata:[],getLength:function(){return this.mdata.length},add:function(e){this.mdata.push(e)},clear:function(e){this.mdata.splice(0,e)},getMultList:function(e){const t=[];for(let n of e){const e=t.findIndex((e=>e[0]&&e[0].type===n.type));-1===e?t.push([n]):t[e].push(n)}const n=[],r=v.getProperties();for(let e of t){const t=e.length?e[0]?.type:"track";n.push({client_id:w._globalData.client_id,type:t,event_list:e.map((e=>{const n={};return Object.keys(e.properties).forEach((t=>{n[t]=e.properties[t]})),"profile"!==t&&Object.keys(r).forEach((e=>{n[e]=r[e]})),{event:e.event,time:e.time,properties:n}}))})}return n}},getStorage:function(){return this.storageInfo||(this.storageInfo=function(e){let t="";try{t=wx.getStorageSync(e)}catch(n){try{t=wx.getStorageSync(e)}catch(e){o("getStorage fail")}}return t}(w._para.storage_store_key)||""),this.storageInfo},init:function(){this.getStorage()||(w._is_first_launch=!0,wx.setStorageSync(w._para.storage_store_key,!0),w.profileSetOnce({$first_visit_time:(new Date).toLocaleString("cn",{hour12:!1}).replaceAll("/","-")}))}},w._para={name:"Gravity Engine",server_url:"https://turbo.api.plutus-cat.com/event_center/api/v1/eventv2/collect/",autoTrack:{appLaunch:!0,appShow:!0,appHide:!0},show_log:!1,storage_store_key:"turbo2022_wechat"},w._meta={life_state:{app_launched:!1}},w.setPara=function(e){w._para=function(e){return p(u.call(arguments,1),(function(t){for(var n in t)void 0!==t[n]&&null!==t[n]&&(l(t[n])&&l(e[n])?f(e[n],t[n]):e[n]=t[n])})),e}(w._para,e),w._para.server_url="https://turbo.api.plutus-cat.com/event_center/api/v1/eventv2/collect/"},w.init=function(e="",t=""){if(!e)throw new Error("access_token must be required.");if(!t)throw new Error("client_id must be required.");v.infoInit(),w._globalData.access_token=e,w._globalData.client_id=t,w._store.init(),wx.onAppShow((function(e){if(!w._meta.life_state.app_launched){const e=wx.getLaunchOptionsSync()||{};w._autoTrackCustom.appLaunch(e)}w._autoTrackCustom.appShow(e)})),wx.onAppHide((function(){w._autoTrackCustom.appHide()})),b.init(),function(){if(!w._meta.life_state.app_launched){const e=wx.getLaunchOptionsSync()||{};w._meta.life_state.app_launched=!0,w._current_scene=e.scene,w._autoTrackCustom.appLaunch(e)}}()};const b={dataHasSend:!0,dataHasChange:!1,syncStorage:!1,failTime:0,is_first_batch_write:!0,init:function(){b.batchInterval()},send:function(e,t){w._store.mem.getLength()>=500&&(o("数据量存储过大，有异常"),w._store.mem.mdata.shift()),e&&(w._store.mem.add(e),t&&t()),w._store.mem.getLength()>=w._batch_send_default.max_length&&this.batchSend()},requestAll:function(e){return new Promise(((t,n)=>{wx.request({url:w._para.server_url+`?access_token=${w._globalData.access_token}`,method:"POST",header:h,data:e,success:function(){t("")},fail:function(){n("")}})}))},wxrequest:function(e){const t=w._store.mem.getMultList(e.data)||[];if(!e?.data?.length)return void e.success(e.len);const n=[];for(let e of t)n.push(this.requestAll(e));Promise.all(n).then((()=>{e.success(e.len)})).catch((()=>{e.fail()}))},batchSend:function(){if(!w._globalData.client_id)return void sendFail();const e=w._store.mem.mdata;e.length&&this.wxrequest({data:e,len:e.length,success:this.batchRemove.bind(this),fail:this.sendFail.bind(this)})},sendFail:function(){this.dataHasSend=!0,this.failTime++},batchRemove:function(e){w._store.mem.clear(e),this.dataHasSend=!0,this.dataHasChange=!0,this.batchWrite(),this.failTime=0},batchWrite:function(){const e=this;this.dataHasChange&&(this.is_first_batch_write&&(this.is_first_batch_write=!1,setTimeout((function(){e.batchSend()}),1e3)),this.dataHasChange=!1)},batchInterval:function(){const e=this;!function t(){setTimeout((function(){e.batchWrite(),t()}),500)}(),function t(){setTimeout((function(){e.batchSend(),t()}),w._batch_send_default.send_timeout*Math.pow(2,e.failTime))}()}},k=function(e,t){if(w._current_scene&&1154===w._current_scene&&!w._para.preset_events.moments_page)return!1;e?(o(e),b.send(e,t)):o("error: 数据异常 ",e)};w.track=function(e,t,n){k({type:"track",event:e,properties:t,time:Date.now()},n)},w.profileSet=function(e,t){k({type:"profile",event:"profile_set",properties:e,time:Date.now()},t)},w.profileSetOnce=function(e,t){k({type:"profile",event:"profile_set_once",properties:e,time:Date.now()},t)},w.profileIncrement=function(e,t){k({type:"profile",event:"profile_increment",properties:e,time:Date.now()},t)},w.profileDelete=function(e){k({type:"profile",event:"profile_delete",properties:{},time:Date.now()},e)},w.profileAppend=function(e,t){k({type:"profile",event:"profile_append",properties:e,time:Date.now()},t)},w.profileUnset=function(e,t){k({type:"profile",event:"profile_unset",properties:{[e]:null},time:Date.now()},t)},w.registerApp=function(e={}){l(e)?v.getRegisterProperties(e):o("error: registerApp 参数必须是对象")},w.registerEvent=function(){w.track("$MPRegister",{})},w.loginEvent=function(){w.track("$MPLogin",{})},w.logoutEvent=function(){w.track("$MPLogout",{})},function(){var e=Page;Page=function(t){try{t.onShareAppMessage=function(){w.track("$MPShare",{$share_method:"转发消息卡片",$share_depth:getCurrentPages().length})},t.onShareTimeline=function(){w.track("$MPShare",{$share_method:"朋友圈分享",$share_depth:getCurrentPages().length})},t.onAddToFavorites=function(){w.track("$MPAddFavorites",{$url_path:_()?.route||""})},e.apply(this,arguments)}catch(t){e.apply(this,arguments)}};var t=Component;Component=function(e){try{e.onShareAppMessage=function(){w.track("$MPShare",{$share_method:"转发消息卡片",$share_depth:getCurrentPages().length})},e.onShareTimeline=function(){w.track("$MPShare",{$share_method:"朋友圈分享",$share_depth:getCurrentPages().length})},e.onAddToFavorites=function(){w.track("$MPAddFavorites",{$url_path:_()?.route||""})},t.apply(this,arguments)}catch(e){t.apply(this,arguments)}}}();const S=w;return t})()));